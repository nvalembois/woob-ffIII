---
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app: ffw
  name: ffw
data:
  default.conf.template: |
      server {
          listen       8080;
          server_name  localhost;
          location / {
              root   /usr/share/nginx/html;
              index  index.html index.htm;
          }
          #error_page  404              /404.html;
          error_page   500 502 503 504  /50x.html;
          location = /50x.html {
              root   /usr/share/nginx/html;
          }
          location /api {
              proxy_pass http://unix:/var/run/python/api.sock;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;
          }
          add_header 'Access-Control-Allow-Origin' '$CORS_ORIGN';
          add_header 'Access-Control-Allow-Methods' '$CORS_METHODS';
      }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: ffw
  name: ffw
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ffw
  template:
    metadata:
      labels:
        app: ffw
    spec:
      containers:
      - image: docker.io/nginxinc/nginx-unprivileged:1.27.1-alpine-slim
        name: frontend
        env:
        - name: CORS_ORIGN
          value: '*'
        - name: CORS_METHODS
          value: 'GET,PUT,POST,OPTIONS'
        ports:
        - containerPort: 8080
          hostPort: 3000
          name: http
          protocol: TCP
        resources: {}
        volumeMounts:
        - name: config
          mountPath: "/etc/nginx/templates"
          readOnly: true
        - name: frontend
          mountPath: "/usr/share/nginx/html"
          readOnly: true
        - name: socket
          mountPath: "/var/run/python"
          readOnly: true
      - image: wff-api:latest
        name: api
        workingDir: /app
        command:
        - uvicorn
        args:
        - app:app
        - --uds
        - /var/run/python/api.sock
        - --workers
        - 3
        - --reload
        env:
        - name: PYTHONPYCACHEPREFIX
          value: /tmp/pycache
        - name: PS1
          value: '(venv) \w \$ '
        resources: {}
        volumeMounts:
        - name: socket
          mountPath: "/var/run/python"
        - name: cache
          mountPath: "/tmp/pycache"
        - name: venv
          mountPath: "/venv"
          readOnly: true
        - name: api
          mountPath: "/app"
          readOnly: true
      hostAliases:
      - hostnames:
        - firefly.local
        ip: '192.168.1.161'
      volumes:
      - name: config
        configMap:
          name: ffw
          items:
          - key: "default.conf.template"
            path: "default.conf.template"
      - name: frontend
        hostPath:
          path: "/home/nicolas/git/apps/woob-ffIII/frontend/dist"
          type: Directory
      - name: api
        hostPath:
          path: "/home/nicolas/git/apps/woob-ffIII/backend/src/app"
          type: Directory
      - name: socket
        emptyDir:
          medium: Memory
          sizeLimit: 10Mi
      - name: venv
        emptyDir:
          medium: Memory
          sizeLimit: 1Gi
      - name: cache
        emptyDir:
          medium: Memory
          sizeLimit: 200Mi